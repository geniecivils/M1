<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>M1 GC</title>
<style>
* {margin:0;padding:0;box-sizing:border-box;user-select:none;-webkit-tap-highlight-color:transparent;font-family:"Dela Gothic One",sans-serif;}
body{display:flex;justify-content:center;align-items:center;background-color:#121212;color:#f1f1f1;padding:10px;margin-top:10px;height:100vh;overflow:hidden;}
#loader{position:fixed;inset:0;background:#000d;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:1000;}
.spinner{border:6px solid #333;border-top:6px solid #10b981;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;}
@keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);} }
#loader p{margin-top:15px;font-size:1.1em;color:#10b981;}
#overlay{position:fixed;inset:0;background:#000d;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:999;opacity:0;transition:opacity .5s ease;}
#overlay.show{opacity:1;}
video{width:300px;height:220px;border-radius:10px;border:2px solid #10b981;background:#000;object-fit:cover}
#message{margin-top:10px;font-size:1.1em;text-align:center;}
.container{display:none;flex-direction:column;justify-content:center;align-items:center;width:100%;max-width:600px;margin:auto;}
.selection-container,.content-container{background-color:#1e1e1e;padding:20px;border-radius:10px;box-shadow:0 0 15px rgba(0,0,0,.5);width:100%;}
.selection-container h2,.content-container h2{text-align:center;padding-bottom:10px;}
.contents{display:flex;justify-content:center;flex-wrap:wrap;}
.btn{display:inline-block;margin:10px;padding:10px 15px;background-color:#1e90ff;color:white;border-radius:10px;text-decoration:none;text-align:center;font-size:1em;cursor:pointer;}
.btn:hover{background-color:#007acc;}
.myword1{background:#79ff5f;padding:10px 50px;border:1px solid #333;border-radius:10px;font-weight:bold;font-size:larger;font-family:"IBM Plex Sans Arabic",sans-serif;}
.myword1:hover{background:#86fd6f;}
.stats {margin-top:12px;text-align:center;font-size:0.95em;color:#cbd5e1;}
#manualCodeContainer{margin-top:15px;display:flex;gap:10px;justify-content:center;align-items:center;}
#manualCodeInput{padding:8px 10px;border-radius:8px;border:none;font-size:1em;}
#manualCodeBtn{padding:8px 15px;border:none;border-radius:8px;background:#10b981;color:#fff;cursor:pointer;}
#manualCodeBtn:hover{background:#0f9c6e;}

/* popup session ended */
#sessionPopup{
  position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;justify-content:center;align-items:center;z-index:2000;
}
#sessionPopupContent{
  background:#1e1e1e;padding:25px 35px;border-radius:15px;box-shadow:0 0 20px rgba(0,0,0,0.6);
  text-align:center;color:#fff;font-size:1.3em;font-family:'IBM Plex Sans Arabic',sans-serif;border:2px solid #e74c3c;
}
#sessionPopupContent button{
  background:#e74c3c;color:white;border:none;padding:8px 20px;border-radius:10px;cursor:pointer;font-size:1em;margin-top:15px;
}
#sessionPopupContent button:hover{background:#c0392b;}
</style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div id="loader">
  <div class="spinner"></div>
  <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„...</p>
</div>

<!-- ÙˆØ§Ø¬Ù‡Ø© QR + Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ -->
<div id="overlay">
  <video id="video" autoplay></video>
  <div id="message">ÙŠØ±Ø¬Ù‰ Ù…Ø³Ø­ Ø±Ù…Ø² Ø§Ù„Ù€ QR Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø¯Ø®ÙˆÙ„...</div>
  <input type="file" id="fileInput" accept="image/*" style="margin-top:10px;">
  <div id="manualCodeContainer">
    <input type="text" id="manualCodeInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§" />
    <button id="manualCodeBtn">ØªØ­Ù‚Ù‚</button>
  </div>
</div>

<!-- popup session ended -->
<div id="sessionPopup">
  <div id="sessionPopupContent">
    ðŸ”’ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©
    <br>
    <button id="popupBtn">Ø­Ø³Ù†Ù‹Ø§</button>
  </div>
</div>

<!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
<div class="container" id="content">
  <div class="selection-container" id="selectionContainer">
    <h2>ðŸ‡µðŸ‡¸</h2>
    <h2>Choisissez le semestre</h2>
    <div class="contents">
      <a href="#" class="btn" onclick="goToPage('contentS1')">S1</a>
      <a href="#" class="btn" onclick="goToPage('contentS2')">S2</a>
    </div>
    <div class="stats">
      <div>Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ø¢Ù†: <span id="onlineCount">--</span></div>
      <div>Ø§Ù„Ø²ÙˆØ§Ø± Ù…Ù†Ø° Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆÙ‚Ø¹: <span id="totalVisitors">--</span></div>
    </div>
  </div>

  <div class="content-container" id="contentS1" style="display:none;">
    <h2>ðŸ‡µðŸ‡¸ Semestre 1</h2>
    <button class="btn" onclick="returnToSelection()">RETOUR</button>
    <button class="myword1">Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ Ùˆ Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ Ùˆ Ù„Ø§ Ø§Ù„Ù‡ Ø§Ù„Ø§ Ø§Ù„Ù„Ù‡ Ùˆ Ø§Ù„Ù„Ù‡ Ø£ÙƒØ¨Ø±</button>
  </div>

  <div class="content-container" id="contentS2" style="display:none;">
    <h2>ðŸ‡µðŸ‡¸ Semestre 2</h2>
    <button class="btn" onclick="returnToSelection()">RETOUR</button>
  </div>
</div>

<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, set, onValue, onDisconnect, update, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4ffOpGSHS3fdRV1X0aztZU7D1hzttYq0",
  authDomain: "my-id-19724.firebaseapp.com",
  databaseURL: "https://my-id-19724-default-rtdb.firebaseio.com",
  projectId: "my-id-19724",
  storageBucket: "my-id-19724.appspot.com",
  messagingSenderId: "788057820357",
  appId: "1:788057820357:web:b37f49ddb60ec489bd34ac",
  measurementId: "G-5QX27XCFK6"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© */
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const loader = document.getElementById('loader');
const message = document.getElementById('message');
const content = document.getElementById('content');
const onlineCountEl = document.getElementById('onlineCount');
const totalVisitorsEl = document.getElementById('totalVisitors');
const manualCodeInput = document.getElementById('manualCodeInput');
const manualCodeBtn = document.getElementById('manualCodeBtn');
const fileInput = document.getElementById('fileInput');
const sessionPopup = document.getElementById("sessionPopup");
const popupBtn = document.getElementById("popupBtn");

let scanning = false;
let streamRef = null;
const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d");
let deviceIdGlobal = null;
let heartbeatIntervalId = null;
let allowedCodesSet = new Set();

/* Fingerprint */
async function getDeviceFingerprint() {
  if (localStorage.getItem("deviceId")) return localStorage.getItem("deviceId");
  const fp = await FingerprintJS.load();
  const result = await fp.get();
  const deviceId = result.visitorId;
  localStorage.setItem("deviceId", deviceId);
  return deviceId;
}
function getDeviceName() {
  try { return `${navigator.platform || "unknown"} â€” ${navigator.userAgent || "unknown"}`; } 
  catch { return "Unknown Device"; }
}
function getLocation() {
  return new Promise((resolve) => {
    if (!("geolocation" in navigator)) return resolve(null);
    navigator.geolocation.getCurrentPosition(
      (pos) => resolve({lat: pos.coords.latitude,lng: pos.coords.longitude,accuracy: pos.coords.accuracy}),
      () => resolve(null),
      { enableHighAccuracy: true, timeout: 8000 }
    );
  });
}

/* ÙƒØ§Ù…ÙŠØ±Ø§ */
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    streamRef = stream;
    scanning = true;
    scanLoop();
  } catch (err) {
    message.textContent = "ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§!";
    console.error(err);
  }
}
function stopCamera() { scanning=false; if(streamRef) streamRef.getTracks().forEach(t=>t.stop()); video.srcObject=null; streamRef=null; }

/* Ù…Ø³Ø­ QR */
async function scanLoop() {
  if (!scanning) return;
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, canvas.width, canvas.height);
    if (code) await handleScannedCode(code.data.trim());
  }
  requestAnimationFrame(scanLoop);
}

/* ØªØ­Ù„ÙŠÙ„ QR Ù…Ù† ØµÙˆØ±Ø© Ù…Ø±ÙÙˆØ¹Ø© */
fileInput.addEventListener("change", async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const img = new Image();
  img.onload = async ()=>{
    canvas.width=img.width; canvas.height=img.height;
    ctx.drawImage(img,0,0);
    const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(imageData.data, canvas.width, canvas.height);
    if(code) await handleScannedCode(code.data.trim());
    else message.textContent="Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù…Ø² QR!";
  };
  img.src = URL.createObjectURL(file);
});

/* load allowed codes */
function startAllowedCodesWatcher() {
  onValue(ref(db,'allowedCodes'), snap => {
    const val = snap.val()||{};
    allowedCodesSet = new Set(Object.keys(val));
  });
}

/* handle code (QR Ø£Ùˆ password) */
async function handleScannedCode(scanned) {
  if (!allowedCodesSet.has(scanned)) { message.textContent = "ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ âŒ"; return; }
  const codeRef = ref(db, "codes/" + scanned);
  const snapshot = await get(codeRef);
  const deviceId = await getDeviceFingerprint();
  deviceIdGlobal = deviceId;

  if (!snapshot.exists() || snapshot.val().usedBy === deviceId) {
    if(!snapshot.exists()) await set(codeRef,{used:true,usedBy:deviceId,lastUsedAt:Date.now()});
    await grantAccess(scanned);
  } else {
    message.textContent = "âŒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ¹Ù…Ù„ Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±";
  }
}

/* grant access */
async function grantAccess(scanned) {
  message.textContent="ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­ âœ…";
  stopCamera();
  const deviceId = await getDeviceFingerprint();
  deviceIdGlobal=deviceId;
  const deviceName=getDeviceName();
  const location=await getLocation();
  const enteredAt=Date.now();
  const sessionRef=ref(db,`sessions/${deviceId}`);
  const sessionData={code:scanned,deviceName,location:location||null,enteredAt,online:true,lastSeen:null,lastHeartbeat:enteredAt,exitAt:null};

  try {
    const visitorRef=ref(db,`visitors/${deviceId}`);
    const visitorSnap=await get(visitorRef);
    await set(sessionRef,sessionData);
    await onDisconnect(sessionRef).update({online:false,lastSeen:Date.now(),exitAt:Date.now()});
    await update(ref(db,`codes/${scanned}`),{used:true,usedBy:deviceId,lastUsedAt:Date.now()});
    if(!visitorSnap.exists()){
      await set(visitorRef,{firstSeen:Date.now(),deviceName});
      const totalRef=ref(db,`counters/totalVisitors`);
      await runTransaction(totalRef,current=>(current||0)+1);
    } else { await update(visitorRef,{lastSeen:Date.now(),deviceName}); }
    localStorage.setItem("qr_access_granted","true");
    localStorage.setItem("qr_code_value",scanned);
    setTimeout(()=>{ overlay.style.display="none"; content.style.display="flex"; startRealtimeSessionWatcher(); startHeartbeat(deviceId); },800);
  } catch(err){ console.error("grantAccess error:",err); message.textContent="Ø®Ø·Ø£ ÙÙŠ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";}
}

/* heartbeat ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© */
function startHeartbeat(deviceId){
  if(heartbeatIntervalId) clearInterval(heartbeatIntervalId);
  heartbeatIntervalId=setInterval(async()=>{
    try{
      await update(ref(db,`sessions/${deviceId}`),{lastHeartbeat:Date.now(),online:true});
    }catch(e){console.warn("Heartbeat failed:",e);}
  },1000);
}
function stopHeartbeat(){ if(heartbeatIntervalId) clearInterval(heartbeatIntervalId); heartbeatIntervalId=null; }

/* realtime watcher & counters */
function startSessionsWatcherAndCounters() {
  onValue(ref(db,'sessions'), snap => {
    const val=snap.val()||{};
    let onlineCount=0;
    Object.values(val).forEach(v=>{ if(v?.online) onlineCount++; });
    set(ref(db,'counters/online'),onlineCount).catch(()=>{});
    onlineCountEl.textContent=onlineCount;
  });
  onValue(ref(db,'counters/totalVisitors'), snap=>{ totalVisitorsEl.textContent=snap.val()||0; });
}

/* Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø³ØªÙ…Ø±Ø© Ù„Ù„Ø¬Ù„Ø³Ø© */
async function startRealtimeSessionWatcher(){
  const savedCode=localStorage.getItem("qr_code_value");
  if(!savedCode) return;
  const deviceId = await getDeviceFingerprint();
  const codeRef=ref(db,"codes/"+savedCode);
  onValue(codeRef, snap=>{
    if(!snap.exists() || snap.val().usedBy!==deviceId){
      stopCamera(); overlay.style.display="flex"; content.style.display="none";
      sessionPopup.style.display="flex";
      localStorage.removeItem("qr_access_granted");
      localStorage.removeItem("qr_code_value");
      stopHeartbeat();
    }
  });
}

/* popup */
popupBtn.onclick=()=> location.reload();

/* init */
(async()=>{
  const deviceId=await getDeviceFingerprint(); deviceIdGlobal=deviceId;
  startAllowedCodesWatcher(); startSessionsWatcherAndCounters();
  setTimeout(async()=>{
    const savedCode=localStorage.getItem("qr_code_value");
    if(savedCode){
      const snap=await get(ref(db,"codes/"+savedCode));
      if(snap.exists() && snap.val().usedBy===deviceId){
        const sessionSnap=await get(ref(db,`sessions/${deviceId}`));
        if(!sessionSnap.exists()) await set(ref(db,`sessions/${deviceId}`),{code:savedCode,deviceName:getDeviceName(),location:null,enteredAt:Date.now(),online:true,lastSeen:null,lastHeartbeat:Date.now(),exitAt:null});
        loader.style.display="none"; overlay.style.display="none"; content.style.display="flex";
        startRealtimeSessionWatcher(); startHeartbeat(deviceId); return;
      }
    }
    loader.style.display="none"; overlay.classList.add("show"); startCamera();
  },1500);
})();

/* navigation */
window.goToPage=function(pageId){ document.querySelectorAll('.content-container').forEach(c=>c.style.display='none'); document.getElementById('selectionContainer').style.display='none'; document.getElementById(pageId).style.display='block'; };
window.returnToSelection=function(){ document.querySelectorAll('.content-container').forEach(c=>c.style.display='none'); document.getElementById('selectionContainer').style.display='block'; };

/* ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬ */
async function updateSessionOffline(){
  try{
    const deviceId=deviceIdGlobal||localStorage.getItem("deviceId");
    if(deviceId) await update(ref(db,`sessions/${deviceId}`),{online:false,lastSeen:Date.now(),exitAt:Date.now()});
  } catch(err){ console.warn(err);}
}
window.addEventListener("beforeunload", updateSessionOffline);
window.addEventListener("unload", updateSessionOffline);

/* ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„ÙŠØ¯ÙˆÙŠØ© */
manualCodeBtn.onclick = async ()=>{
  const code = manualCodeInput.value.trim();
  if(code) await handleScannedCode(code);
};
</script>
</body>
</html>
