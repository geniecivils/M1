<!DOCTYPE html>
<html lang="fr" >
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>M1 GC</title>
<link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=IBM+Plex+Sans+Arabic:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="icon" href="https://png.pngtree.com/png-vector/20241030/ourmid/pngtree-yellow-hard-hat-vector-png-image_14185637.png">
<style>
/* Reset & base */
html, body { height: 100vh; }
* {margin:0;padding:0;box-sizing:border-box;user-select:none;-webkit-tap-highlight-color:transparent;font-family:"Dela Gothic One",sans-serif;}
/* scrollbar */
::-webkit-scrollbar { width: 10px; }
::-webkit-scrollbar-track { background-color: transparent; border-radius: 10px; }
::-webkit-scrollbar-thumb { background-color: #2c2c2c; border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background-color: #333; cursor: pointer; }

#fileInput{ display: flex; width: 20%; }
h4{ color: #333; font-size: 1.5em; text-align: center; }
h3{text-align: center;}

body{
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: #121212;
  color: #f1f1f1;
  padding: 10px;
  margin-top: 10px;
  min-height: 100vh;
}

/* loader & overlays */
#loader{position:fixed;inset:0;background:#000d;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:1000;}
.spinner{border:6px solid #333;border-top:6px solid #007acc;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;}
@keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);} }
#loader p{margin-top:15px;font-size:1.1em;color:#007acc;}
#overlay{position:fixed;inset:0;background:#000d;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:999;opacity:0;transition:opacity .5s ease;pointer-events:none;}
#overlay.show{opacity:1;pointer-events:auto;}
video{width:300px;height:220px;border-radius:10px;border:2px solid #007acc;background:#000;object-fit:cover}
#message{margin-top:10px;font-size:1.1em;text-align:center;}

/* containers */
.container{ display: none; justify-content: center; align-items: center; flex-direction: column; width: 100%; max-width: 900px; margin: auto;}
.selection-container,.content-container{background-color:#1e1e1e;padding:20px;border-radius:10px;box-shadow:0 0 15px rgba(0,0,0,.5);width:100%;}
.selection-container h2,.content-container h2{text-align:center;padding-bottom:10px;}
.contents{display:flex;justify-content:center;flex-wrap:wrap;flex-direction: row-reverse;}
.btn{text-decoration:none;display:inline-block;margin:10px;padding:10px 15px;background-color:#1e90ff;color:white;border-radius:10px;text-decoration:none;text-align:center;font-size:1em;cursor:pointer; border: none;}
.btn:hover{background-color:#007acc;}

/* refresh row */
.button-row { display: flex; gap: 10px; justify-content: center; width: 100%; }
.btn-refresh { background-color: #28a745; }
.btn-refresh:hover { background-color: #218838; }

/* banner */
.myword1{ background:#79ff5f; padding:10px 50px; border:1px solid #333; border-radius:10px; font-weight:bold; font-size:larger; font-family:"IBM Plex Sans Arabic",sans-serif; margin: 10px 0; width: 100%; border-bottom: 1px solid #333; }
.myword1:hover{background:#86fd6f;}

.stats {margin-top:12px;text-align:center;font-size:0.95em;color:#cbd5e1;}
#manualCodeContainer{margin-top:15px;display:flex;gap:10px;justify-content:center;align-items:center; width: 70%;}
#manualCodeInput{padding:8px 10px;border-radius:8px;border:none;font-size:1em; width:100%; }
#manualCodeBtn{padding:8px 15px;border:none;border-radius:8px;background:#1e90ff;color:#fff;cursor:pointer; width: 50%;}
#manualCodeBtn:hover{background:#007acc;}

/* popup */
#sessionPopup{ position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;justify-content:center;align-items:center;z-index:2000; }
#sessionPopupContent{ background:#1e1e1e;padding:25px 35px;border-radius:15px;box-shadow:0 0 20px rgba(0,0,0,0.6);text-align:center;color:#fff;font-size:1.3em;font-family:'IBM Plex Sans Arabic',sans-serif;border:2px solid #e74c3c; }
#sessionPopupContent button{ background:#e74c3c;color:white;border:none;padding:8px 20px;border-radius:10px;cursor:pointer;font-size:1em;margin-top:15px; }
#sessionPopupContent button:hover{background:#c0392b;}

/* materials / grid */
.materials{display:flex;justify-content:center;flex-wrap:wrap;gap:15px;margin-top:15px;margin: 10px 0;border: 1px solid #333;border-radius: 10px;padding: 10px;}
.material-btn{width: 100px;height: 100px;background: #2c2c2c;color: #fff;border-radius: 10px;display: flex;justify-content: center;align-items: center;text-align: center;cursor: pointer;font-size: 1em;padding: 10px;border: 2px solid #2c2c2c;}
.material-btn:hover{background:#1e1e1e;}

/* pdf container overlay */
.pdf-container{position:fixed;inset:0;background:#000d;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:3000;padding:10px;}
.pdf-container iframe{width:100%;height:90%;border:none;border-radius:10px;}
.pdf-close-btn { position: fixed; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.7); color: #fff; border: none; padding: 40px 15px; border-radius: 8px; cursor: pointer; z-index: 4000; pointer-events: auto; }

/* subject / accordion */
.subject-section { margin: 10px 0; border: 1px solid #333; border-radius: 10px; background-color: #1e1e1e; width: 100%; overflow:hidden; }
.subject-section h3 {
  color: #ffffff; margin-bottom: 0; background-color: #2c2c2c; padding: 10px; border-bottom: 1px solid #333; border-radius: 10px 10px 0 0; cursor: pointer; display:flex; justify-content:space-between; align-items:center; font-size:1em;
}
.subject-section h3:hover { background-color: #333; }
.subject-section h3 span.icon { margin-inline-start: 10px; font-weight: bold; }

/* grid: use responsive minmax */
.pdf-grid {
  display: none;
  grid-template-columns: repeat(auto-fit,minmax(90px,1fr));
  gap: 10px;
  justify-content: center;
  justify-items: center;
  padding: 10px;
  direction: ltr;
}
.pdf-grid.open { display: grid; }

/* small card */
.pdf-box { width: 90px; background: #2c2c2c; color: #f1f1f1; border: 2px solid #2c2c2c; border-radius: 10px; display:flex; align-items:center; justify-content:center; text-align:center; cursor:pointer; font-size:1em; padding:10px 5px; }
.pdf-box:hover { background-color:#1e1e1e; color:#f1f1f1; }

/* accessibility focus */
.subject-section h3:focus { outline: 3px solid rgba(0,122,204,0.5); outline-offset: 2px; }

@media (max-width:600px){
  video{width:240px;height:170px;}
  #manualCodeContainer{width:90%;}
}
</style>
</head>
<body>
<div id="loader">
 <div class="spinner"></div>
 <p>V√©rification de la connexion...</p>
</div>

<div id="overlay" role="dialog" aria-modal="true">
 <video id="video" autoplay playsinline></video>
 <div id="message">Veuillez scanner le code QR ou saisir le code pour entrer...</div>
 <input type="file" id="fileInput" accept="image/*" style="margin-top:10px;">
 <div id="manualCodeContainer">
  <input type="text" id="manualCodeInput" placeholder="Entrez le code ici" />
  <button id="manualCodeBtn">v√©rification</button>
 </div>
</div>

<div id="sessionPopup">
 <div id="sessionPopupContent">
  SESSION TERMINEE üîí
  <br>
  <button id="popupBtn">OK</button>
 </div>
</div>

<div class="container" id="content" aria-live="polite">
 <div class="selection-container" id="selectionContainer">
  <h2>üáµüá∏</h2>
  <h3> üë∑üèª‚Äç‚ôÄÔ∏è M1 STRUCTURE üë∑üèª‚Äç‚ôÇÔ∏è </h3>
  <h2>Choisissez le semestre</h2>
  <div class="contents">
   <a href="#" class="btn" onclick="goToPage('contentS2')">S2</a>
   <a href="#" class="btn" onclick="goToPage('contentS1')">S1</a>
  </div>
  <h4>X</h4>
 </div>

 <div class="content-container" id="contentS1" style="display:none;">
  <h2>üáµüá∏</h2>
  <h2>Semestre 1</h2>
  <div class="button-row">
    <button class="btn" onclick="returnToSelection()">RETOUR</button>
    <button class="btn btn-refresh" onclick="location.reload()">REFRESH</button>
  </div>

  <button class="myword1">ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá Ÿà ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá Ÿà ŸÑÿß ÿßŸÑŸá ÿßŸÑÿß ÿßŸÑŸÑŸá Ÿà ÿßŸÑŸÑŸá ÿ£ŸÉÿ®ÿ±</button>

  <div class="subject-section">
   <h3 onclick="togglePdfList('mds-grid')" data-acc-id="mds-grid" aria-controls="mds-grid" aria-expanded="false">MDS <span class="icon">‚ñº</span></h3>
   <div class="pdf-grid" id="mds-grid" aria-hidden="true">
    <div class="pdf-box" onclick="openPDF('https://drive.google.com/file/d/1SOvG9-Tzdl7LF-Z0rxYJ0KRw5w3Rxt3j/preview?embedded=true')">PDF 1</div>
    <div class="pdf-box" onclick="openPDF('https://drive.google.com/file/d/1SOvG9-Tzdl7LF-Z0rxYJ0KRw5w3Rxt3j/preview?embedded=true')">PDF 2</div>
    <div class="pdf-box" onclick="openPDF('https://drive.google.com/file/d/1SOvG9-Tzdl7LF-Z0rxYJ0KRw5w3Rxt3j/preview?embedded=true')">PDF 3</div>
    <div class="pdf-box" onclick="openPDF('https://drive.google.com/file/d/1SOvG9-Tzdl7LF-Z0rxYJ0KRw5w3Rxt3j/preview?embedded=true')">PDF 3</div>

   </div>
  </div>

  <div class="subject-section">
   <h3 onclick="togglePdfList('dds-grid')" data-acc-id="dds-grid" aria-controls="dds-grid" aria-expanded="false">DDS <span class="icon">‚ñº</span></h3>
   <div class="pdf-grid" id="dds-grid" aria-hidden="true">
    <div class="pdf-box" onclick="openPDF('https://drive.google.com/file/d/1SOvG9-Tzdl7LF-Z0rxYJ0KRw5w3Rxt3j/preview?embedded=true')">PDF 1</div>
    <div class="pdf-box" onclick="openPDF('https://drive.google.com/file/d/1SOvG9-Tzdl7LF-Z0rxYJ0KRw5w3Rxt3j/preview?embedded=true')">PDF 2</div>
    <div class="pdf-box" onclick="openPDF('https://drive.google.com/file/d/1SOvG9-Tzdl7LF-Z0rxYJ0KRw5w3Rxt3j/preview?embedded=true')">PDF 3</div>
         <div class="pdf-box" onclick="openPDF('https://drive.google.com/file/d/1SOvG9-Tzdl7LF-Z0rxYJ0KRw5w3Rxt3j/preview?embedded=true')">PDF 1</div>
    <div class="pdf-box" onclick="openPDF('https://drive.google.com/file/d/1SOvG9-Tzdl7LF-Z0rxYJ0KRw5w3Rxt3j/preview?embedded=true')">PDF 2</div>
    <div class="pdf-box" onclick="openPDF('https://drive.google.com/file/d/1SOvG9-Tzdl7LF-Z0rxYJ0KRw5w3Rxt3j/preview?embedded=true')">PDF 3</div>
         <div class="pdf-box" onclick="openPDF('https://drive.google.com/file/d/1SOvG9-Tzdl7LF-Z0rxYJ0KRw5w3Rxt3j/preview?embedded=true')">PDF 1</div>
    <div class="pdf-box" onclick="openPDF('https://drive.google.com/file/d/1SOvG9-Tzdl7LF-Z0rxYJ0KRw5w3Rxt3j/preview?embedded=true')">PDF 2</div>
    <div class="pdf-box" onclick="openPDF('https://drive.google.com/file/d/1SOvG9-Tzdl7LF-Z0rxYJ0KRw5w3Rxt3j/preview?embedded=true')">PDF 3</div>

   </div>
  </div>

  <div class="subject-section">
   <h3 onclick="togglePdfList('beton-grid')" data-acc-id="beton-grid" aria-controls="beton-grid" aria-expanded="false">BETON <span class="icon">‚ñº</span></h3>
   <div class="pdf-grid" id="beton-grid" aria-hidden="true"></div>
  </div>

  <div class="subject-section">
   <h3 onclick="togglePdfList('charpente-grid')" data-acc-id="charpente-grid" aria-controls="charpente-grid" aria-expanded="false">CHARPENTE <span class="icon">‚ñº</span></h3>
   <div class="pdf-grid" id="charpente-grid" aria-hidden="true"></div>
  </div>

  <h4>X</h4>
 </div>

 <div class="content-container" id="contentS2" style="display:none;">
  <h2>üáµüá∏</h2>
  <h2>Semestre 2</h2>
  <div class="button-row">
    <button class="btn" onclick="returnToSelection()">RETOUR</button>
    <button class="btn btn-refresh" onclick="location.reload()">REFRESH</button>
  </div>

  <button class="myword1">ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá Ÿà ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá Ÿà ŸÑÿß ÿßŸÑŸá ÿßŸÑÿß ÿßŸÑŸÑŸá Ÿà ÿßŸÑŸÑŸá ÿ£ŸÉÿ®ÿ±</button>

  <div class="materials"></div>
 </div>
</div>

<div class="pdf-container" id="pdfContainer" aria-hidden="true">
 <button class="pdf-close-btn" onclick="closePDF()">RETOUR</button>
 <iframe id="pdfFrame" src="" title="PDF viewer"></iframe>
</div>

<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
<script type="module">
// Firebase imports (unchanged)
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, set, onValue, onDisconnect, update, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4ffOpGSHS3fdRV1X0aztZU7D1hzttYq0",
  authDomain: "my-id-19724.firebaseapp.com",
  databaseURL: "https://my-id-19724-default-rtdb.firebaseio.com",
  projectId: "my-id-19724",
  storageBucket: "my-id-19724.appspot.com",
  messagingSenderId: "788057820357",
  appId: "1:788057820357:web:b37f49ddb60ec489bd34ac",
  measurementId: "G-5QX27XCFK6"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* UI elements */
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const loader = document.getElementById('loader');
const message = document.getElementById('message');
const content = document.getElementById('content');
const manualCodeInput = document.getElementById('manualCodeInput');
const manualCodeBtn = document.getElementById('manualCodeBtn');
const fileInput = document.getElementById('fileInput');
const sessionPopup = document.getElementById("sessionPopup");
const popupBtn = document.getElementById("popupBtn");
const pdfContainer = document.getElementById('pdfContainer');
const pdfFrame = document.getElementById('pdfFrame');

let scanning = false;
let streamRef = null;
const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d");
let deviceIdGlobal = null;
let heartbeatIntervalId = null;
let allowedCodesSet = new Set();

/* Fingerprint */
async function getDeviceFingerprint() {
  if (localStorage.getItem("deviceId")) return localStorage.getItem("deviceId");
  const fp = await FingerprintJS.load();
  const result = await fp.get();
  const deviceId = result.visitorId;
  localStorage.setItem("deviceId", deviceId);
  return deviceId;
}

function getDeviceName() {
  try { return `${navigator.platform || "unknown"} ‚Äî ${navigator.userAgent || "unknown"}`; }
  catch { return "Unknown Device"; }
}

function getLocation() {
  return new Promise((resolve) => {
    if (!("geolocation" in navigator)) return resolve(null);
    navigator.geolocation.getCurrentPosition(
      (pos) => resolve({lat: pos.coords.latitude,lng: pos.coords.longitude,accuracy: pos.coords.accuracy}),
      () => resolve(null),
      { enableHighAccuracy: true, timeout: 8000 }
    );
  });
}

/* camera */
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    streamRef = stream;
    scanning = true;
    scanLoop();
  } catch (err) {
    message.textContent = "L'appareil photo n'a pas pu d√©marrer !";
    console.error(err);
  }
}
function stopCamera() { scanning=false; if(streamRef) streamRef.getTracks().forEach(t=>t.stop()); video.srcObject=null; streamRef=null; }

/* scan loop */
async function scanLoop() {
  if (!scanning) return;
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, canvas.width, canvas.height);
    if (code) await handleScannedCode(code.data.trim());
  }
  requestAnimationFrame(scanLoop);
}

/* handle image file QR */
fileInput.addEventListener("change", async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const img = new Image();
  img.onload = async ()=>{
    canvas.width=img.width; canvas.height=img.height;
    ctx.drawImage(img,0,0);
    const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(imageData.data, canvas.width, canvas.height);
    if(code) await handleScannedCode(code.data.trim());
    else message.textContent="Aucun code QR trouv√©!";
  };
  img.src = URL.createObjectURL(file);
});

/* allowed codes watcher */
function startAllowedCodesWatcher() {
  onValue(ref(db,'allowedCodes'), snap => {
    const val = snap.val()||{};
    allowedCodesSet = new Set(Object.keys(val));
  });
}

/* handle scanned or manual code */
async function handleScannedCode(scanned) {
  if (!allowedCodesSet.has(scanned)) { message.textContent = "Code invalide ‚ùå"; return; }
  const codeRef = ref(db, "codes/" + scanned);
  const snapshot = await get(codeRef);
  const deviceId = await getDeviceFingerprint();
  deviceIdGlobal = deviceId;

  if (!snapshot.exists() || snapshot.val().usedBy === deviceId) {
    if(!snapshot.exists()) await set(codeRef,{used:true,usedBy:deviceId,lastUsedAt:serverTimestamp()});
    await grantAccess(scanned);
  } else {
    message.textContent = "‚ùå Ce code est utilis√© depuis un autre appareil";
  }
}

/* ---------- Presence helpers (NEW) ---------- */
/* Ensure onDisconnect and presence monitoring via .info/connected + local handlers */

async function setupPresence(deviceId){
  try{
    // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßÿ™ÿµÿßŸÑ ÿßŸÑŸÄ socket ŸÖÿπ Firebase
    const connectedRef = ref(db, ".info/connected");
    onValue(connectedRef, async snap => {
      const isConnected = !!snap.val();
      const sessionRef = ref(db, `sessions/${deviceId}`);

      if (isConnected) {
        try{
          // ÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸÜÿß ŸÜÿπŸÑŸéŸÜ ÿ£ŸàŸÜŸÑÿßŸäŸÜ ŸàŸÜÿ≥ÿ¨ŸëŸÑ onDisconnect ÿπŸÑŸâ ÿßŸÑÿÆÿßÿØŸÖ
          await update(sessionRef, { online: true, lastHeartbeat: serverTimestamp() });

          // onDisconnect ÿπŸÑŸâ ÿßŸÑÿÆÿßÿØŸÖ ‚Äî ŸÅŸä ÿ≠ÿßŸÑ ÿßŸÜŸÇÿ∑ÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ ŸÅÿ¨ÿ£ÿ©
          await onDisconnect(sessionRef).update({
            online: false,
            lastSeen: serverTimestamp(),
            exitAt: serverTimestamp()
          });
        }catch(e){
          console.warn("setupPresence - error setting onDisconnect/update:", e);
        }
      } else {
        // ŸÑÿß ÿ≠ÿßÿ¨ÿ© ŸÑŸÅÿπŸÑ ÿ¥Ÿäÿ° ÿ•ÿ∂ÿßŸÅŸä ‚Äî onDisconnect ÿ≥ŸäÿπÿßŸÑÿ¨ ÿ≠ÿßŸÑÿ© ÿßŸÑÿÆÿßÿØŸÖ
      }
    });
  } catch(err){
    console.warn("setupPresence failed:", err);
  }
}

function addRobustVisibilityHandlers(deviceId){
  // visibilitychange : ÿ≥ÿ±Ÿäÿπ ŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ£ŸàŸÅŸÑÿßŸäŸÜ ŸàŸÇÿ™ ÿßŸÑÿßÿÆÿ™ŸÅÿßÿ°
  document.addEventListener('visibilitychange', () => {
    if (!localStorage.getItem("qr_code_value")) return;
    if (document.visibilityState === 'visible') {
      updateSessionOnline();
    } else {
      updateSessionOffline();
    }
  });

  // pagehide : ŸäÿπŸÖŸÑ ÿ¨ŸäÿØÿßŸã ÿπŸÑŸâ ÿßŸÑŸáŸàÿßÿ™ŸÅ ÿπŸÜÿØ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿ™ÿ®ŸàŸäÿ®/ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
  window.addEventListener('pagehide', () => {
    if (!localStorage.getItem("qr_code_value")) return;
    updateSessionOffline();
  }, {passive:true});

  // blur : ŸÇÿØ Ÿäÿ≠ÿØÿ´ ÿπŸÜÿØ ÿ±ÿ¨Ÿàÿπ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÑŸÑÿÆŸÑŸÅŸäÿ© (Android WebView / Chrome)
  window.addEventListener('blur', () => { if (localStorage.getItem("qr_code_value")) updateSessionOffline(); });

  // freeze : Page Lifecycle API (ÿ®ÿπÿ∂ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ÿßÿ™)
  document.addEventListener('freeze', () => { if (localStorage.getItem("qr_code_value")) updateSessionOffline(); });

  // beforeunload / unload ŸÉŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
  window.addEventListener('beforeunload', () => { if (localStorage.getItem("qr_code_value")) updateSessionOffline(); });
  window.addEventListener('unload', () => { if (localStorage.getItem("qr_code_value")) updateSessionOffline(); });

  // Cordova/Capacitor events (ÿ•ŸÜ ŸàŸèÿ¨ÿØÿ™)
  window.addEventListener('resume', () => { updateSessionOnline(); });
  window.addEventListener('pause', () => { updateSessionOffline(); });
}

/* grant access */
async function grantAccess(scanned) {
  message.textContent="V√©rifi√© avec succ√®s ‚úÖ";
  stopCamera();
  const deviceId = await getDeviceFingerprint();
  deviceIdGlobal=deviceId;
  const deviceName=getDeviceName();
  const location=await getLocation();

  const sessionRef=ref(db,`sessions/${deviceId}`);

  const sessionData={
      code:scanned,
      deviceName,
      location:location||null,
      enteredAt:serverTimestamp(),
      online:true,
      lastSeen:null,
      lastHeartbeat:serverTimestamp(),
      exitAt:null
  };

  try {
    const visitorRef=ref(db,`visitors/${deviceId}`);
    const visitorSnap=await get(visitorRef);

    // write session
    await set(sessionRef,sessionData);

    // onDisconnect: ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿπŸÑŸâ ÿßŸÑÿÆÿßÿØŸÖ ŸÅŸä ÿ≠ÿßŸÑ ÿßŸÜŸÇÿ∑ÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ ŸÅÿ¨ÿ£ÿ©
    await onDisconnect(sessionRef).update({
        online:false,
        lastSeen:serverTimestamp(),
        exitAt:serverTimestamp()
    });

    // update code usage
    await update(ref(db,`codes/${scanned}`),{used:true,usedBy:deviceId,lastUsedAt:serverTimestamp()});

    if(!visitorSnap.exists()){
        await set(visitorRef,{firstSeen:serverTimestamp(),deviceName});
        const totalRef=ref(db,`counters/totalVisitors`);
        await runTransaction(totalRef,current=>(current||0)+1);
    } else {
        await update(visitorRef,{lastSeen:serverTimestamp(),deviceName});
    }

    localStorage.setItem("qr_access_granted","true");
    localStorage.setItem("qr_code_value",scanned);
    sessionStorage.setItem('currentPageId', 'selectionContainer');

    // === NEW: ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ≠ÿ∂Ÿàÿ± (onDisconnect + ŸÖÿ±ÿßŸÇÿ®ÿ© .info/connected) Ÿà ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿµŸÅÿ≠ÿ© ===
    try{
      setupPresence(deviceId);                // Ÿäÿ∂ŸÖŸÜ onDisconnect Ÿà update ÿπŸÑŸâ ÿßŸÑÿÆÿßÿØŸÖ
      addRobustVisibilityHandlers(deviceId);  // Ÿäÿ∂ŸäŸÅ ŸÖÿ≥ÿ™ŸÖÿπŸäŸÜ ŸÖÿ≠ŸÑŸäŸäŸÜ ŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ£ŸàŸÅŸÑÿßŸäŸÜ ŸÅŸàÿ±ÿßŸã
    }catch(e){ console.warn("Presence setup failed:", e); }
    // === end NEW ===

    setTimeout(()=>{
      overlay.classList.remove("show");
      overlay.style.display = "none";
      content.style.display="flex";
      startRealtimeSessionWatcher();
      startHeartbeat(deviceId);
    },800);
  } catch(err){ console.error("grantAccess error:",err); message.textContent="ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑÿ¨ŸÑÿ≥ÿ©. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ."; }
}

/* heartbeat */
function startHeartbeat(deviceId){
  if(heartbeatIntervalId) clearInterval(heartbeatIntervalId);
  heartbeatIntervalId=setInterval(async()=>{
    try{
      if (document.hidden) {
        stopHeartbeat();
        updateSessionOffline();
        return;
      }
      await update(ref(db,`sessions/${deviceId}`),{lastHeartbeat:serverTimestamp(),online:true});
    }catch(e){console.warn("Heartbeat failed:",e);}
  },1000);
}
function stopHeartbeat(){ if(heartbeatIntervalId) clearInterval(heartbeatIntervalId); heartbeatIntervalId=null; }

/* realtime session watcher */
async function startRealtimeSessionWatcher(){
  const savedCode=localStorage.getItem("qr_code_value");
  if(!savedCode) return;
  const deviceId = await getDeviceFingerprint();
  const codeRef=ref(db,"codes/"+savedCode);
  onValue(codeRef, snap=>{
    if(!snap.exists() || snap.val().usedBy!==deviceId){
      stopCamera(); overlay.style.display="flex"; overlay.classList.add("show"); content.style.display="none";
      sessionPopup.style.display="flex";
      localStorage.removeItem("qr_access_granted");
      localStorage.removeItem("qr_code_value");
      sessionStorage.removeItem('currentPageId');
      sessionStorage.removeItem('openAccordionId');
      sessionStorage.removeItem('openPdfUrl');
      stopHeartbeat();
      updateSessionOffline();
    }
  });
}

/* popup */
popupBtn.onclick=()=> location.reload();

/* init */
(async()=>{
  loader.style.display = "flex";
  const deviceId = await getDeviceFingerprint();
  deviceIdGlobal = deviceId;
  startAllowedCodesWatcher();

  const savedCode = localStorage.getItem("qr_code_value");
  let sessionIsValid = false;

  if (savedCode) {
    try {
      const snap = await get(ref(db, "codes/" + savedCode));
      if (snap.exists() && snap.val().usedBy === deviceId) {
        sessionIsValid = true;
      }
    } catch (e) {
      console.error("Error checking saved session:", e);
      sessionIsValid = false;
    }
  }

  loader.style.display = "none";

  if (sessionIsValid) {
    overlay.classList.remove("show");
    overlay.style.display = "none";
    content.style.display = "flex";

    const savedPageId = sessionStorage.getItem('currentPageId');
    if (savedPageId && savedPageId !== 'selectionContainer') {
      goToPage(savedPageId);
      if (savedPageId === 'contentS1') {
        const openAccordionId = sessionStorage.getItem('openAccordionId');
        if (openAccordionId) {
          try {
            const pdfList = document.getElementById(openAccordionId);
            const title = document.querySelector(`[data-acc-id="${openAccordionId}"]`);
            if (pdfList) {
              pdfList.classList.add('open');
              pdfList.setAttribute('aria-hidden','false');
            }
            if (title) {
              title.setAttribute('aria-expanded','true');
              const icon = title.querySelector('span.icon');
              if (icon) icon.textContent = '‚ñ≤';
            }
          } catch (e) {
            console.warn("Failed to restore accordion:", e);
            sessionStorage.removeItem('openAccordionId');
          }
        }
      }
    } else {
      returnToSelection();
    }

    const openPdfUrl = sessionStorage.getItem('openPdfUrl');
    if (openPdfUrl) openPDF(openPdfUrl);

    // Ensure presence watchers are active after reload
    try{
      setupPresence(deviceId);
      addRobustVisibilityHandlers(deviceId);
    }catch(e){ console.warn("Presence re-setup failed:", e); }

    startRealtimeSessionWatcher();
    if (!document.hidden) {
      startHeartbeat(deviceId);
      updateSessionOnline();
    } else updateSessionOffline();
  } else {
    localStorage.removeItem("qr_access_granted");
    localStorage.removeItem("qr_code_value");
    sessionStorage.removeItem('currentPageId');
    sessionStorage.removeItem('openAccordionId');
    sessionStorage.removeItem('openPdfUrl');

    overlay.style.display = "flex";
    overlay.classList.add("show");
    startCamera();
  }

  // accessibility: attach keyboard controls to all accordion headers
  attachAccordionAccessibility();
})();

/* navigation */
window.goToPage=function(pageId){
  document.querySelectorAll('.content-container').forEach(c=>c.style.display='none');
  document.getElementById('selectionContainer').style.display='none';
  document.getElementById(pageId).style.display='block';
  sessionStorage.setItem('currentPageId', pageId);
};
window.returnToSelection=function(){
  document.querySelectorAll('.content-container').forEach(c=>c.style.display='none');
  document.getElementById('selectionContainer').style.display='block';
  sessionStorage.setItem('currentPageId', 'selectionContainer');
  sessionStorage.removeItem('openAccordionId');
};

/* Accordion toggle (keeps single-open behavior, updates aria & session) */
window.togglePdfList = function(id) {
  const allPdfLists = document.querySelectorAll('#contentS1 .pdf-grid');
  const allTitles = document.querySelectorAll('#contentS1 .subject-section h3');

  const pdfList = document.getElementById(id);
  if (!pdfList) return;

  const title = document.querySelector(`[data-acc-id="${id}"]`);
  const icon = title ? title.querySelector('span.icon') : null;

  const isOpening = !pdfList.classList.contains('open');

  // close all
  allPdfLists.forEach(list => {
    list.classList.remove('open');
    list.setAttribute('aria-hidden','true');
  });
  allTitles.forEach(t => {
    t.setAttribute('aria-expanded','false');
    const s = t.querySelector('span.icon');
    if (s) s.textContent = "‚ñº";
  });

  if (isOpening) {
    pdfList.classList.add('open');
    pdfList.setAttribute('aria-hidden','false');
    if (icon) icon.textContent = "‚ñ≤";
    if (title) title.setAttribute('aria-expanded','true');
    sessionStorage.setItem('openAccordionId', id);
  } else {
    sessionStorage.removeItem('openAccordionId');
  }
};

/* attach keyboard accessibility to accordion headers */
function attachAccordionAccessibility(){
  const headers = document.querySelectorAll('#contentS1 .subject-section h3');
  headers.forEach(h => {
    h.setAttribute('role','button');
    if (!h.hasAttribute('tabindex')) h.setAttribute('tabindex','0');
    if (!h.hasAttribute('aria-expanded')) h.setAttribute('aria-expanded','false');

    // keyboard: Enter or Space toggles
    h.addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter' || ev.key === ' ' || ev.key === 'Spacebar') {
        ev.preventDefault();
        const id = h.getAttribute('data-acc-id');
        if (id) togglePdfList(id);
      }
    });

    // also clicking sets aria automatically via togglePdfList
  });
}

/* session updates when leaving/returning */
async function updateSessionOffline(){
  try{
    const deviceId=deviceIdGlobal||localStorage.getItem("deviceId");
    if(deviceId) {
      const sessionRef = ref(db, `sessions/${deviceId}`);
      const snap = await get(sessionRef);
      if (snap.exists()) {
        await update(sessionRef, {online:false, lastSeen:serverTimestamp(), exitAt:serverTimestamp()});
      }
    }
  } catch(err){ console.warn(err); }
}
window.addEventListener("beforeunload", updateSessionOffline);
window.addEventListener("unload", updateSessionOffline);
window.addEventListener("pagehide", updateSessionOffline);

/* update online when returning */
async function updateSessionOnline(){
  try{
    const deviceId = deviceIdGlobal || await getDeviceFingerprint();
    if(!deviceId) return;
    const savedCode = localStorage.getItem("qr_code_value");
    if (!savedCode) return;
    const codeSnap = await get(ref(db, "codes/" + savedCode));
    if (codeSnap.exists() && codeSnap.val().usedBy === deviceId) {
      const sessionRef = ref(db, `sessions/${deviceId}`);
      await update(sessionRef, {online:true, lastHeartbeat:serverTimestamp(), exitAt:null});
      if(!heartbeatIntervalId) startHeartbeat(deviceId);
    } else {
      stopHeartbeat();
    }
  } catch(err){ console.warn("updateSessionOnline failed:", err); }
}

/* visibility change handling */
function handleVisibilityChange() {
  if (!localStorage.getItem("qr_code_value")) return;
  if (document.hidden) {
    stopHeartbeat();
    updateSessionOffline();
  } else {
    updateSessionOnline();
  }
}
document.addEventListener("visibilitychange", handleVisibilityChange, false);

/* manual code */
manualCodeBtn.onclick = async ()=>{ const code = manualCodeInput.value.trim(); if(code) await handleScannedCode(code); };

/* PDF open/close (state saved) */
window.openPDF=function(url){
  pdfFrame.src=url;
  pdfContainer.style.display='flex';
  pdfContainer.setAttribute('aria-hidden','false');
  sessionStorage.setItem('openPdfUrl', url);
}
window.closePDF=function(){
  pdfContainer.style.display='none';
  pdfFrame.src='';
  pdfContainer.setAttribute('aria-hidden','true');
  sessionStorage.removeItem('openPdfUrl');
}

/* block context menu & dev keys */
document.addEventListener('contextmenu', function(event) { event.preventDefault(); });
document.addEventListener('keydown', function(event) {
  if (event.key === 'F12' ||
  (event.ctrlKey && event.shiftKey && (event.key === 'I' || event.key === 'J')) ||
  (event.ctrlKey && event.key === 'U')) {
    event.preventDefault();
  }
});
</script>
</body>
</html>
