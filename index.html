<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>M1 GC</title>
<style>
* {margin:0;padding:0;box-sizing:border-box;user-select:none;-webkit-tap-highlight-color:transparent;font-family:"Dela Gothic One",sans-serif;}
body{display:flex;justify-content:center;align-items:center;background-color:#121212;color:#f1f1f1;padding:10px;margin-top:10px;height:100vh;overflow:hidden;}
#loader{position:fixed;inset:0;background:#000d;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:1000;}
.spinner{border:6px solid #333;border-top:6px solid #10b981;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;}
@keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
#loader p{margin-top:15px;font-size:1.1em;color:#10b981;}
#overlay{position:fixed;inset:0;background:#000d;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:999;opacity:0;transition:opacity .5s ease;}
#overlay.show{opacity:1;}
video{width:300px;height:220px;border-radius:10px;border:2px solid #10b981;background:#000;object-fit:cover}
#message{margin-top:10px;font-size:1.1em;text-align:center;}
.container{display:none;flex-direction:column;justify-content:center;align-items:center;width:100%;max-width:600px;margin:auto;}
.selection-container,.content-container{background-color:#1e1e1e;padding:20px;border-radius:10px;box-shadow:0 0 15px rgba(0,0,0,.5);width:100%;}
.selection-container h2,.content-container h2{text-align:center;padding-bottom:10px;}
.contents{display:flex;justify-content:center;}
.btn{display:inline-block;margin:10px;padding:10px 15px;background-color:#1e90ff;color:white;border-radius:10px;text-decoration:none;text-align:center;font-size:1em;}
.btn:hover{background-color:#007acc;}
.myword1{background:#79ff5f;padding:10px 50px;border:1px solid #333;border-radius:10px;font-weight:bold;font-size:larger;font-family:"IBM Plex Sans Arabic",sans-serif;}
.myword1:hover{background:#86fd6f;}
</style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div id="loader">
  <div class="spinner"></div>
  <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„...</p>
</div>

<!-- ÙˆØ§Ø¬Ù‡Ø© QR -->
<div id="overlay">
  <video id="video" autoplay></video>
  <div id="message">ÙŠØ±Ø¬Ù‰ Ù…Ø³Ø­ Ø±Ù…Ø² Ø§Ù„Ù€ QR Ù„Ù„Ø¯Ø®ÙˆÙ„...</div>
  <input type="file" id="fileInput" accept="image/*" style="margin-top:10px;">
</div>

<!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
<div class="container" id="content">
  <div class="selection-container" id="selectionContainer">
    <h2>ğŸ‡µğŸ‡¸</h2>
    <h2>Choisissez le semestre</h2>
    <div class="contents">
      <a href="#" class="btn" onclick="goToPage('contentS1')">S1</a>
      <a href="#" class="btn" onclick="goToPage('contentS2')">S2</a>
    </div>
  </div>

  <div class="content-container" id="contentS1" style="display:none;">
    <h2>ğŸ‡µğŸ‡¸ Semestre 1</h2>
    <button class="btn" onclick="returnToSelection()">RETOUR</button>
    <button class="myword1">Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ Ùˆ Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ Ùˆ Ù„Ø§ Ø§Ù„Ù‡ Ø§Ù„Ø§ Ø§Ù„Ù„Ù‡ Ùˆ Ø§Ù„Ù„Ù‡ Ø£ÙƒØ¨Ø±</button>
  </div>

  <div class="content-container" id="contentS2" style="display:none;">
    <h2>ğŸ‡µğŸ‡¸ Semestre 2</h2>
    <button class="btn" onclick="returnToSelection()">RETOUR</button>
  </div>
</div>

<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>

<script type="module">
/*
  Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©: ØªØ¶ÙŠÙ ØªØªØ¨Ù‘Ø¹ ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø­Ø§Ù„Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†/Ø£ÙˆÙÙ„Ø§ÙŠÙ†ØŒ Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (lat/lng/accuracy)ØŒ Ùˆ heartbeat Ø¯ÙˆØ±ÙŠ.
  â€¢ Ø§Ù„Ø¹Ù‚Ø¯Ø©: sessions/{deviceId} Ø³ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: online, enteredAt, lastSeen, lastHeartbeat, deviceName, location, code
  â€¢ Ø£ÙŠØ¶Ø§Ù‹ Ù†Ø­Ø¯Ù‘Ø« codes/{code} Ø¨Ø¥Ø¯Ø®Ø§Ù„ Ø¢Ø®Ø±/Ù…Ù† ÙŠØ³ØªØ®Ø¯Ù…Ù‡.
*/

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getDatabase,
  ref,
  get,
  set,
  onValue,
  onDisconnect,
  update
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4ffOpGSHS3fdRV1X0aztZU7D1hzttYq0",
  authDomain: "my-id-19724.firebaseapp.com",
  databaseURL: "https://my-id-19724-default-rtdb.firebaseio.com",
  projectId: "my-id-19724",
  storageBucket: "my-id-19724.appspot.com",
  messagingSenderId: "788057820357",
  appId: "1:788057820357:web:b37f49ddb60ec489bd34ac",
  measurementId: "G-5QX27XCFK6"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© */
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const loader = document.getElementById('loader');
const message = document.getElementById('message');
const content = document.getElementById('content');

/* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
const allowedCodes = ["123456", "654321", "112233", "445566", "4455667"];
let scanning = false;
let streamRef = null;
const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d");

/* Ø­Ø§Ù„Ø© ØªØªØ¨Ø¹ */
let deviceIdGlobal = null;
let heartbeatIntervalId = null;

/* Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø² (FingerprintJS) */
async function getDeviceFingerprint() {
  if (localStorage.getItem("deviceId")) return localStorage.getItem("deviceId");
  const fp = await FingerprintJS.load();
  const result = await fp.get();
  const deviceId = result.visitorId;
  localStorage.setItem("deviceId", deviceId);
  return deviceId;
}

/* Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø§Ø² - Ù†Ø¬Ù…Ø¹ info Ù…Ù† Ø§Ù„ÙŠÙˆØ²Ø±-Ø£Ø¬Ù†Øª ÙˆØ¨Ù„Ø§ØªÙÙˆØ±Ù… */
function getDeviceName() {
  try {
    const ua = navigator.userAgent || "unknown";
    const platform = navigator.platform || "unknown";
    return `${platform} â€” ${ua}`;
  } catch (e) {
    return "Unknown Device";
  }
}

/* Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (lat/lng) Ø¥Ù† Ø³Ù…Ø­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
function getLocation() {
  return new Promise((resolve) => {
    if (!("geolocation" in navigator)) return resolve(null);
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        resolve({
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          accuracy: pos.coords.accuracy
        });
      },
      (err) => {
        // Ø¥Ù† Ø±ÙØ¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø®Ø·Ø£ØŒ Ù†Ø¹ÙŠØ¯ null
        console.warn("Geolocation error:", err);
        resolve(null);
      },
      { enableHighAccuracy: true, timeout: 8000 }
    );
  });
}

/* Ø¨Ø¯Ø¡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    streamRef = stream;
    scanning = true;
    scanLoop();
  } catch (err) {
    message.textContent = "ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§!";
    console.error(err);
  }
}
function stopCamera() {
  scanning = false;
  if (streamRef) streamRef.getTracks().forEach(track => track.stop());
  video.srcObject = null;
  streamRef = null;
}

/* Ø­Ù„Ù‚Ø© Ø§Ù„Ù…Ø³Ø­ */
async function scanLoop() {
  if (!scanning) return;
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, canvas.width, canvas.height);
    if (code) await handleScannedCode(code.data.trim());
  }
  requestAnimationFrame(scanLoop);
}

/* Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ù…Ø³ÙˆØ­ -- Ù…Ø¹ ØªØªØ¨Ù‘Ø¹ ÙÙŠ Firebase */
async function handleScannedCode(scanned) {
  if (!allowedCodes.includes(scanned)) { message.textContent = "ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ âŒ"; return; }

  const codeRef = ref(db, "codes/" + scanned);
  const snapshot = await get(codeRef);
  const deviceId = await getDeviceFingerprint();
  deviceIdGlobal = deviceId;

  if (!snapshot.exists()) {
    await set(codeRef, { used: true, usedBy: deviceId, time: Date.now() });
    await grantAccess(scanned);
  } else if (snapshot.val().usedBy === deviceId) {
    await grantAccess(scanned);
  } else {
    message.textContent = "âŒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ¹Ù…Ù„ Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±";
  }
}

/* Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ©: Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ù…Ù„ÙƒÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ù†Ø®Ø±Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
async function startRealtimeSessionWatcher() {
  const savedCode = localStorage.getItem("qr_code_value");
  if (!savedCode) return;
  const deviceId = await getDeviceFingerprint();
  const codeRef = ref(db, "codes/" + savedCode);

  onValue(codeRef, (snap) => {
    if (!snap.exists() || snap.val().usedBy !== deviceId) {
      // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙˆØ±Ù‹Ø§
      localStorage.removeItem("qr_access_granted");
      localStorage.removeItem("qr_code_value");
      stopCamera();
      content.style.display = "none";
      overlay.style.display = "flex";
      message.textContent = "";
      popup.style.display = "flex";
    }
  });
}

/* Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© */
const popup = document.createElement("div");
popup.style.position = "fixed";
popup.style.inset = "0";
popup.style.background = "rgba(0,0,0,0.8)";
popup.style.display = "none";
popup.style.justifyContent = "center";
popup.style.alignItems = "center";
popup.style.zIndex = "2000";
popup.innerHTML = `
  <div style="background:#1e1e1e;padding:25px 35px;border-radius:15px;box-shadow:0 0 20px rgba(0,0,0,0.6);text-align:center;color:#fff;font-size:1.3em;font-family:'IBM Plex Sans Arabic',sans-serif;border:2px solid #e74c3c;">
    ğŸ”’ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø© <br><br>
    <button id="popupBtn" style="background:#e74c3c;color:white;border:none;padding:8px 20px;border-radius:10px;cursor:pointer;font-size:1em;">Ø­Ø³Ù†Ù‹Ø§</button>
  </div>`;
document.body.appendChild(popup);
popup.querySelector("#popupBtn").onclick = () => location.reload();

/* ØªØ­Ø¯ÙŠØ« heartbeat Ø¯ÙˆØ±ÙŠ ÙÙŠ sessions/{deviceId}/lastHeartbeat */
function startHeartbeat(deviceId) {
  // Ø­Ø¯ Ø£Ù‚ØµÙ‰: ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 20 Ø«Ø§Ù†ÙŠØ©
  if (heartbeatIntervalId) clearInterval(heartbeatIntervalId);
  heartbeatIntervalId = setInterval(async () => {
    try {
      await update(ref(db, `sessions/${deviceId}`), { lastHeartbeat: Date.now() });
    } catch (e) {
      console.warn("Heartbeat failed:", e);
    }
  }, 20000);
}
function stopHeartbeat() {
  if (heartbeatIntervalId) clearInterval(heartbeatIntervalId);
  heartbeatIntervalId = null;
}

/* Ù…Ù†Ø­ Ø§Ù„ÙˆØµÙˆÙ„: ÙŠÙƒØªØ¨ session ÙÙŠ Firebase Ù…Ø¹ onDisconnect Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø£ÙˆÙÙ„Ø§ÙŠÙ† */
async function grantAccess(scanned) {
  message.textContent = "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­ âœ…";
  stopCamera();

  const deviceId = await getDeviceFingerprint();
  deviceIdGlobal = deviceId;
  const deviceName = getDeviceName();
  const location = await getLocation(); // Ù‚Ø¯ ÙŠÙƒÙˆÙ† null
  const enteredAt = Date.now();

  // ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
  const sessionRef = ref(db, `sessions/${deviceId}`);
  const sessionData = {
    code: scanned,
    deviceName,
    location: location || null,
    enteredAt,
    online: true,
    lastSeen: null,
    lastHeartbeat: enteredAt
  };

  try {
    await set(sessionRef, sessionData);

    // Ø¹Ù„Ù‰ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„: Ø¶Ø¹ online=false Ùˆ lastSeen
    await onDisconnect(sessionRef).update({
      online: false,
      lastSeen: Date.now()
    });

    // Ø­Ø¯Ù‘Ø« Ø£ÙŠØ¶Ø§Ù‹ ÙƒØ§Ø¦Ù† Ø§Ù„ÙƒÙˆØ¯ (Ù…Ø¹Ù„ÙˆÙ…Ø© Ø¥Ø¶Ø§ÙÙŠØ©)
    await update(ref(db, `codes/${scanned}`), {
      used: true,
      usedBy: deviceId,
      lastUsedAt: Date.now()
    });

    // Ø®Ø²Ù‘Ù† ÙÙŠ localStorage Ù„Ù„ÙˆÙ„ÙˆØ¬ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    localStorage.setItem("qr_access_granted", "true");
    localStorage.setItem("qr_code_value", scanned);

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØªØ´ØºÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ùˆ heartbeat
    setTimeout(() => {
      overlay.style.display = "none";
      content.style.display = "flex";
      startRealtimeSessionWatcher();
      startHeartbeat(deviceId);
    }, 800);

  } catch (err) {
    console.error("grantAccess error:", err);
    message.textContent = "Ø®Ø·Ø£ ÙÙŠ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
  }
}

/* ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© QR (Ù…Ù„Ù) */
document.getElementById('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const img = new Image();
  img.onload = async () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, canvas.width, canvas.height);
    if (code) await handleScannedCode(code.data.trim());
    else message.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ QR ØµØ§Ù„Ø­ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© âŒ";
  };
  img.src = URL.createObjectURL(file);
});

/* Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© - ÙŠØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ø³Ø¬Ù‘Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§ */
(async () => {
  const deviceId = await getDeviceFingerprint();
  deviceIdGlobal = deviceId;
  const savedCode = localStorage.getItem("qr_code_value");

  setTimeout(async () => {
    if (savedCode) {
      const snap = await get(ref(db, "codes/" + savedCode));
      if (snap.exists() && snap.val().usedBy === deviceId) {
        // ØªØ­Ù‚Ù‚ Ø¥Ø¶Ø§ÙÙŠ: ØªØ£ÙƒÙ‘Ø¯ Ø£Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ø³Ø¬Ù‘Ù„Ø© ÙƒÙ€ online â€” Ø¥Ù† Ù„Ù… ÙŠÙƒÙ†ØŒ Ù†Ø¹ÙŠØ¯ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¬Ù„Ø³Ø©
        const sessionSnap = await get(ref(db, `sessions/${deviceId}`));
        if (sessionSnap.exists()) {
          const s = sessionSnap.val();
          // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª offline Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ù†Ø¹ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
          if (!s.online) {
            // Ø£Ø¹Ø¯ ØªØ¹ÙŠÙŠÙ† online
            await update(ref(db, `sessions/${deviceId}`), { online: true, lastHeartbeat: Date.now() });
          }
        } else {
          // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù‚ØµÙŠØ±Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯
          await set(ref(db, `sessions/${deviceId}`), {
            code: savedCode,
            deviceName: getDeviceName(),
            location: null,
            enteredAt: Date.now(),
            online: true,
            lastSeen: null,
            lastHeartbeat: Date.now()
          });
          await onDisconnect(ref(db, `sessions/${deviceId}`)).update({ online: false, lastSeen: Date.now() });
        }

        loader.style.display = "none";
        overlay.style.display = "none";
        content.style.display = "flex";
        startRealtimeSessionWatcher();
        startHeartbeat(deviceId);
        return;
      }
    }
    loader.style.display = "none";
    overlay.classList.add("show");
    startCamera();
  }, 1500);
})();

/* Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª */
window.goToPage = function(pageId) {
  document.querySelectorAll('.content-container').forEach(c => c.style.display = 'none');
  document.getElementById('selectionContainer').style.display = 'none';
  document.getElementById(pageId).style.display = 'block';
};
window.returnToSelection = function() {
  document.querySelectorAll('.content-container').forEach(c => c.style.display = 'none');
  document.getElementById('selectionContainer').style.display = 'block';
};

/* ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ session Ù„Ùˆ Ø£ØºÙ„Ù‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµÙØ­Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ (Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¶Ø§Ø¹ÙØ© Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ù„Ø³Ø©) */
window.addEventListener("beforeunload", async (e) => {
  try {
    const deviceId = deviceIdGlobal || localStorage.getItem("deviceId");
    if (deviceId) {
      // Ù†Ø­Ø¯Ø« Ø¢Ø®Ø± Ù…Ø´Ø§Ù‡Ø¯Ø© Ùˆ online=false
      await update(ref(db, `sessions/${deviceId}`), { online: false, lastSeen: Date.now() });
    }
  } catch (err) {
    // Ù„Ø§ Ù†ÙØ¹Ù„ Ø§Ù„ÙƒØ«ÙŠØ± Ù„Ø£Ù† beforeunload ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø±ÙŠØ¹Ø§Ù‹
    console.warn("beforeunload update failed:", err);
  }
});
</script>
</body>
</html>
